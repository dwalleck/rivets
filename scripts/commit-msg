#!/bin/bash
# Conventional Commits validation hook for rivets
# https://www.conventionalcommits.org/en/v1.0.0/

COMMIT_MSG_FILE="$1"

# Validate input file exists
if [[ ! -f "$COMMIT_MSG_FILE" ]]; then
    echo "ERROR: Commit message file not found: $COMMIT_MSG_FILE"
    exit 1
fi

COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Skip merge commits
if echo "$COMMIT_MSG" | grep -qE "^Merge "; then
    exit 0
fi

# Skip fixup and squash commits (used during interactive rebase)
if echo "$COMMIT_MSG" | grep -qE "^(fixup|squash)! "; then
    exit 0
fi

# Valid commit types
TYPES="feat|fix|docs|style|refactor|perf|test|build|ci|chore"

# Conventional commit pattern: type(optional-scope)!?: description
# - Scope must be lowercase with hyphens (e.g., cli, mcp)
# - Description must be at least 3 characters
PATTERN="^($TYPES)(\([a-z][a-z0-9-]*\))?!?: .{3,}"

if ! echo "$COMMIT_MSG" | head -1 | grep -qE "$PATTERN"; then
    echo ""
    echo "ERROR: Commit message does not follow Conventional Commits format."
    echo ""
    echo "Expected format: <type>[optional scope]: <description>"
    echo ""
    echo "Valid types:"
    echo "  feat     - New feature (MINOR version bump)"
    echo "  fix      - Bug fix (PATCH version bump)"
    echo "  docs     - Documentation changes"
    echo "  style    - Code style (formatting, semicolons, etc.)"
    echo "  refactor - Code refactoring"
    echo "  perf     - Performance improvements"
    echo "  test     - Adding or updating tests"
    echo "  build    - Build system or dependencies"
    echo "  ci       - CI/CD configuration"
    echo "  chore    - Maintenance tasks"
    echo ""
    echo "Suggested scopes (optional, lowercase):"
    echo "  cli, storage, mcp, jsonl"
    echo ""
    echo "Requirements:"
    echo "  - Scopes must be lowercase (e.g., cli not CLI)"
    echo "  - Description must be at least 3 characters"
    echo ""
    echo "Examples:"
    echo "  feat(cli): add export command"
    echo "  fix(storage): handle empty files gracefully"
    echo "  docs: update installation instructions"
    echo "  feat!: redesign API (breaking change)"
    echo ""
    echo "Your commit message:"
    echo "  $(echo "$COMMIT_MSG" | head -1)"
    echo ""
    exit 1
fi

exit 0
